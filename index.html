<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Grocery List</title>
    <!-- Basic PWA Metadata -->
    <link rel="manifest" id="pwa-manifest" href="#">
    <meta name="theme-color" content="#10b981">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons for UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#10b981', // Emerald green
                        'primary-dark': '#059669',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
        }
        /* Custom animation for the microphone button */
        .listening {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        .mic-icon {
            transform: scale(1.1);
        }
        /* List item animation */
        .list-item-enter-active, .list-item-leave-active {
            transition: all 0.5s ease;
        }
        .list-item-enter-from, .list-item-leave-to {
            opacity: 0;
            transform: translateY(10px);
        }
    </style>
</head>
<body class="min-h-screen pt-12 pb-8 px-4">

    <div class="max-w-xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8 border border-gray-100">
        <h1 class="text-4xl font-extrabold text-primary mb-2 text-center">
            <span class="inline-block align-middle mr-2">
                <i data-lucide="shopping-cart" class="w-8 h-8"></i>
            </span>
            Offline Groceries
        </h1>
        <p class="text-sm text-center text-gray-500 mb-6">Voice input, always available.</p>

        <!-- Input Section -->
        <div class="flex flex-col space-y-4 mb-8">
            <!-- Text Input (Fallback) -->
            <form id="add-form" class="flex space-x-2">
                <input type="text" id="item-input" placeholder="Add item manually (e.g., bread)" 
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary-dark transition duration-150 outline-none shadow-sm text-lg">
                <button type="submit" 
                        class="p-3 bg-primary hover:bg-primary-dark text-white rounded-lg shadow-md transition duration-150 flex items-center justify-center">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
            </form>

            <!-- Voice Input Button -->
            <button id="mic-button" 
                    class="w-full py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-lg flex items-center justify-center space-x-2 transition duration-200 disabled:opacity-50"
                    title="Click to speak your item (e.g., 'Add milk')">
                <i data-lucide="mic" class="w-6 h-6 mic-icon"></i>
                <span id="mic-status-text">Add Item by Voice</span>
            </button>
            
            <!-- Message Display for Voice/Offline status -->
            <div id="status-message" class="text-sm text-center py-2 px-4 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>
        </div>

        <!-- Grocery List -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Your List</h2>
        <div id="grocery-list" class="space-y-3">
            <!-- List items will be rendered here -->
            <p id="list-empty-message" class="text-gray-500 text-center py-4">Your grocery list is empty. Start adding items!</p>
        </div>

    </div>

    <script>
        // --- IndexedDB Configuration ---
        const DB_NAME = 'GroceryListDB';
        const STORE_NAME = 'groceries';
        const DB_VERSION = 1;
        let db;

        // --- DOM Elements ---
        const listEl = document.getElementById('grocery-list');
        const itemInputEl = document.getElementById('item-input');
        const addFormEl = document.getElementById('add-form');
        const emptyMessageEl = document.getElementById('list-empty-message');
        const micButtonEl = document.getElementById('mic-button');
        const micStatusTextEl = document.getElementById('mic-status-text');
        const statusMessageEl = document.getElementById('status-message');

        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        // --- Utility Functions ---

        /** Displays a temporary status message to the user. */
        function showStatusMessage(message, type = 'info') {
            statusMessageEl.textContent = message;
            statusMessageEl.className = 'text-sm text-center py-2 px-4 rounded-lg';
            statusMessageEl.classList.remove('hidden');

            if (type === 'error') {
                statusMessageEl.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                statusMessageEl.classList.add('bg-green-100', 'text-green-800');
            } else {
                statusMessageEl.classList.add('bg-yellow-100', 'text-yellow-800');
            }

            setTimeout(() => {
                statusMessageEl.classList.add('hidden');
            }, 5000);
        }

        // --- IndexedDB Logic ---

        /** Initializes or opens the IndexedDB database. */
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB initialized successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    showStatusMessage('Database failed to load. Offline features may not work.', 'error');
                    reject(event.target.error);
                };
            });
        }

        /** Retrieves all items from the grocery store. */
        function getItems() {
            return new Promise((resolve, reject) => {
                if (!db) return resolve([]);
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    resolve(event.target.result.sort((a, b) => b.createdAt - a.createdAt)); // Sort newest first
                };

                request.onerror = (event) => {
                    console.error('Error fetching items:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /** Adds a new item to the grocery store. */
        function addItemDB(name) {
            return new Promise((resolve, reject) => {
                if (!db) return reject('Database not ready');
                const newItem = {
                    id: crypto.randomUUID(), // Modern way to generate unique IDs
                    name: name.trim().toLowerCase(),
                    createdAt: Date.now(),
                };

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(newItem);

                request.onsuccess = () => {
                    resolve(newItem);
                };

                request.onerror = (event) => {
                    console.error('Error adding item:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        /** Deletes an item from the grocery store by ID. */
        function deleteItemDB(id) {
            return new new Promise((resolve, reject) => {
                if (!db) return reject('Database not ready');
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => {
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('Error deleting item:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // --- UI Rendering Logic ---

        /** Renders the entire list from the database results. */
        async function renderList() {
            const items = await getItems();
            listEl.innerHTML = '';

            if (items.length === 0) {
                emptyMessageEl.classList.remove('hidden');
                return;
            }
            emptyMessageEl.classList.add('hidden');

            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-gray-50', 'rounded-lg', 'shadow-sm', 'border-l-4', 'border-primary', 'list-item-enter-active');
                itemEl.setAttribute('data-id', item.id);
                
                // Capitalize first letter for display
                const displayName = item.name.charAt(0).toUpperCase() + item.name.slice(1);
                
                itemEl.innerHTML = `
                    <span class="text-xl font-medium text-gray-800">${displayName}</span>
                    <button class="remove-btn p-1 text-gray-400 hover:text-red-500 transition duration-150" data-id="${item.id}" title="Delete item">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                `;
                
                listEl.appendChild(itemEl);
                // Initialize Lucide icons for the new element
                lucide.createIcons();
            });
        }

        // --- Main Application Handlers ---

        /** Processes the name and adds it to the list. */
        async function processNewItem(name, source = 'manual') {
            const trimmedName = name.trim();
            if (trimmedName === '') return;

            try {
                // Ensure name is clean, removing common voice command prefixes
                let cleanedName = trimmedName.toLowerCase()
                    .replace(/^(add|put|get|i need|can i have)\s+/, '') // Remove common prefixes
                    .trim();

                if (cleanedName.endsWith('.')) {
                    cleanedName = cleanedName.slice(0, -1);
                }
                
                await addItemDB(cleanedName);
                await renderList();
                
                if (source === 'voice') {
                    showStatusMessage(`Successfully added: ${cleanedName.charAt(0).toUpperCase() + cleanedName.slice(1)}`, 'success');
                }
                
            } catch (error) {
                showStatusMessage('Could not add item to offline database.', 'error');
            }
        }

        // --- Event Listeners and Initializers ---

        // 1. Manual Add Form
        addFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemName = itemInputEl.value;
            processNewItem(itemName, 'manual');
            itemInputEl.value = ''; // Clear input
        });

        // 2. Delete Button Handler (Event Delegation)
        listEl.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.remove-btn');
            if (deleteButton) {
                const itemId = deleteButton.getAttribute('data-id');
                try {
                    // Start removal animation before deleting
                    const itemEl = listEl.querySelector(`[data-id="${itemId}"]`);
                    if (itemEl) {
                        itemEl.classList.remove('list-item-enter-active');
                        itemEl.classList.add('list-item-leave-to');
                        setTimeout(async () => {
                            await deleteItemDB(itemId);
                            await renderList();
                        }, 500); // Wait for animation to finish
                    }
                } catch (error) {
                    showStatusMessage('Failed to delete item from database.', 'error');
                }
            }
        });
        
        // 3. PWA Manifest (Inline definition for single-file approach)
        const manifestContent = {
            "name": "Offline Grocery List",
            "short_name": "Groceries",
            "description": "Your offline-first, voice-enabled grocery list.",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#10b981",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/10b981/ffffff?text=GL",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/10b981/ffffff?text=GL",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifestContent)], {type: 'application/json'});
        document.getElementById('pwa-manifest').href = URL.createObjectURL(manifestBlob);


        // --- Speech Recognition Handler ---
        
        function setupSpeechRecognition() {
            if (!SpeechRecognition) {
                micButtonEl.disabled = true;
                micButtonEl.classList.remove('bg-red-500', 'hover:bg-red-600');
                micButtonEl.classList.add('bg-gray-400');
                micStatusTextEl.textContent = 'Voice Not Supported';
                showStatusMessage('Speech recognition is not supported in this browser.', 'error');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false; // Only capture a single phrase
            recognition.interimResults = false; // Only return final result
            recognition.lang = 'en-US';

            // When the user stops speaking, this event fires with the result
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Voice Input:', transcript);
                processNewItem(transcript, 'voice');
            };

            // Error handling (e.g., permission denied, no speech detected)
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let message = 'Voice input failed.';
                if (event.error === 'not-allowed') {
                    message = 'Microphone permission denied. Please enable it in your browser settings.';
                } else if (event.error === 'no-speech') {
                    message = 'No speech detected. Please speak louder or more clearly.';
                }
                showStatusMessage(message, 'error');
                // Ensure UI state is reset on error
                isListening = false;
                micButtonEl.classList.remove('listening', 'bg-red-500');
                micButtonEl.classList.add('hover:bg-red-600');
                micStatusTextEl.textContent = 'Add Item by Voice';
            };

            // Handles the end of the voice session (fired after result or error)
            recognition.onend = () => {
                isListening = false;
                micButtonEl.classList.remove('listening', 'bg-red-500');
                micButtonEl.classList.add('hover:bg-red-600');
                micStatusTextEl.textContent = 'Add Item by Voice';
                micButtonEl.disabled = false;
            };

            // Toggle function for the button
            micButtonEl.addEventListener('click', () => {
                if (!isListening) {
                    try {
                        recognition.start();
                        isListening = true;
                        micButtonEl.classList.add('listening', 'bg-red-500');
                        micButtonEl.classList.remove('hover:bg-red-600');
                        micStatusTextEl.textContent = 'Listening... Speak Now';
                        micButtonEl.disabled = true; // Prevent multiple clicks while listening
                    } catch (e) {
                        console.error("Recognition start failed, likely already running or permission issue.", e);
                    }
                } else {
                    recognition.stop();
                    isListening = false;
                }
            });
        }
        
        // --- Main Bootstrap ---
        window.onload = async () => {
            // 1. Initialize DB
            await initDB();
            
            // 2. Load existing items
            await renderList();
            
            // 3. Setup voice recognition
            setupSpeechRecognition();
            
            // 4. Create Lucide icons
            lucide.createIcons();

            // 5. Check offline status
            if (!navigator.onLine) {
                showStatusMessage('You are currently offline. Data is saved locally.', 'info');
            }
        };

    </script>
</body>
</html>